<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Start</title>
    <script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js"
            integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>
    <script src="js/wagyu_contract_helper.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/wagyuchain.css"/>
</head>
<body>
<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <!-- Brand/logo -->
    <a class="navbar-brand" href="index.html">WagyuChain</a>

    <!-- Links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="Abattoir.html">Abattoir</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Consumer.html">Consumer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Farmer.html">Farmer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Retailer.html">Retailer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Vetinarian.html">Vetinarian</a>
        </li>
    </ul>
    <div class="collapse navbar-collapse" id="navbarSupportedContent-4">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="fab fa-user"></i><b>Account</b></a>
            </li>
            <li class="nav-item dropdown">
                <div class="dropdown show">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                        Select Account...
                    </button>

                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink">
                        <a class="dropdown-item" href="#">Add Account</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</nav>
<div class="container-fluid">
    <br/>
    Click to Deploy <input type="button" id="btnDeployContract" value="Deploy Contract" class="btn btn-dark"
                           onclick="deployContract();">
</div>
<script>
    let web3 = null;
    window.addEventListener('load', function () {
        if (typeof window.web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
            alert("Metamask Connected");
        } else {
            web3 = new Web3(new Web3.providers.HttpProvider("http://127.0.0.1:8545"));
            if (!web3.isConnected()) {
                alert('Cannot connected to local provider, is it running?');
                return;
            }
        }

        if(web3 === null) {
            $('#btnDeployContract').prop('value', 'Error');
            alert("Unable to deploy contract, see developer console.")
        } else {
            // contract deployed address
            if(web3.eth.getCode(deployAddress) !== "0x") {
                alert("Contract already deployed.");
                $('#btnDeployContract').prop('value', 'Redeploy');
            }

        }
    });

    function deployContract() {
        initContract(web3);
        let wagyuchainContract = getWeb3Contract();
        if (wagyuchainContract) {
            wagyuchainContract.new(
                {
                    from: fromAddress, // web3.eth.accounts[9] (Ganache Accounts - Index 9)
                    data: byteCode,
                    gas: min_gas
                }, function (e, contract) {
                    console.log(e, contract);
                    if (typeof contract.address !== 'undefined') {
                        console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                        $('#btnDeployContract').prop('value', 'Redeploy');
                    }
                });
        } else {
            console.log("Web3 Contract is null, cannot deploy!");
            alert('Web3 Contract is null, cannot deploy!');
        }
    };

</script>
</body>
</html>