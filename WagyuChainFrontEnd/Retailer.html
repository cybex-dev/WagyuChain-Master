<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Farmer</title>
    <script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/web3.js"></script>
    <script src="js/wagyu_contract_helper.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/wagyuchain.css"/>
</head>
<body>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <!-- Brand/logo -->
    <a class="navbar-brand" href="index.html">WagyuChain</a>

    <!-- Links -->
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="Abattoir.html">Abattoir</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Consumer.html">Consumer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Farmer.html">Farmer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="Retailer.html">Retailer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="Vetinarian.html">Vetinarian</a>
        </li>
    </ul>
    <div class="collapse navbar-collapse" id="navbarSupportedContent-4">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link">
                    <i class="fab fa-user"></i><b>Account</b></a>
            </li>
            <li class="nav-item dropdown">
                <div class="dropdown show">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                        Select Account...
                    </button>

                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuLink"
                         id="navbarProfiles">
                        <!--Add ether accounts here with template below-->
                        <!--<a class="dropdown-item" href="#">Add Account</a>-->
                    </div>
                </div>
            </li>
            <li class="nav-item">
                <a class="nav-link"><span id="activeAccountBalance"></span></a>
            </li>
        </ul>
    </div>
</nav>
<div class="container-fluid">
    <div id="alert-container"></div>
    <br/>
    <div class="card">
        <div class="card-body">
            <h2>Retailer Menu</h2>
        </div>
    </div>
    <br/>
    <div class="alert alert-danger alert-dismissible fade show" role="alert" id="error_alert_box"
         hidden>
        <strong>Errors</strong>
        <ul id="error_list">
        </ul>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="card">
        <div class="card-header bg-light" data-toggle="collapse" href="#inputGroup01" style="cursor: pointer">
            Purchase Parts
        </div>
        <div class="collapse" id="inputGroup01">
            <div class="card-body">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="inputGroupSelect01">Cow</label>
                    </div>
                    <select class="custom-select" id="inputGroupSelect01">
                        <option selected>Choose...</option>
                    </select>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Part ID</span>
                    </div>
                    <input type="number" class="form-control" aria-label="Amount (to the nearest dollar)"
                           id="inputPurchasePartId">
                </div>
                <a href="#" onclick="addCow()" class="btn btn-primary">Purchase</a>
            </div>
        </div>
    </div>
    <br/>
    <div class="card">
        <div class="card-header bg-light" data-toggle="collapse" href="#inputGroup02" style="cursor: pointer">
            Set Part Value
        </div>
        <div class="collapse" id="inputGroup02">
            <div class="card-body">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <label class="input-group-text" for="inputGroupSelect02">Cow</label>
                    </div>
                    <select class="custom-select" id="inputGroupSelect02">
                        <option selected>Choose...</option>
                    </select>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Part ID</span>
                    </div>
                    <input type="number" class="form-control" aria-label="Amount (to the nearest dollar)"
                           id="inputPartValuePartId">
                </div>
                <Strong class="card-text">Current Part price is </Strong><p class="card-text" id="inputCurrentPartPrice"></p>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Part ID</span>
                    </div>
                    <input type="number" class="form-control" aria-label="Amount (to the nearest dollar)"
                           id="inputPurchaseNewPartValue">
                </div>
                <a href="#" onclick="setPartValue()" class="btn btn-primary">New Part Value</a>
            </div>
        </div>
    </div>
    <br/>
</div>
<script>
    window.addEventListener('activeAccountChanged', function (data) {
        document.getElementById("inputTextVetAddress").value = data.detail;
        document.querySelectorAll("#navbarProfiles")[0].parentElement.firstElementChild.textContent = data.detail;
    });

    window.addEventListener('etherAccountsUpdated', function (data) {
        addEntriesToSelect('inputGroupSelect01', data.detail);
        addEntriesToSelect('inputGroupSelect02', data.detail);
    });

    function transferPart() {
        //Clear error list and set hidden
        $('#error_list').empty();
        $('#error_alert_box').attr("hidden");

        let cowAddress = $('#inputGroupSelect01').val();
        if (cowAddress === "" || cowAddress === "Choose...") {
            addItemToList(document.getElementById("error_list"), "Cow Address cannot be empty");
        }

        let partId = $('#inputPartValuePartId').val();
        if (partId === "") {
            addItemToList(document.getElementById("error_list"), "Part ID cannot be empty");
        }

        if (document.querySelectorAll("#error_list > li").length > 0) {
            console.log("Errors while adding cow.");
            $('#error_alert_box').removeAttr("hidden");
        } else {

            web3Contract.transferPart.sendTransaction(cowAddress, partId, _activeAccount, {
                from: _activeAccount,
                gas: 1000000,
                gasPrice: 100
            }, (error, result) => {
                if (error !== null) {
                    alert(error);
                } else {
                    console.log("Wagyu part purchased ( " + result + ")");
                }
            });
        }
    };

    function setPartValue() {
        //Clear error list and set hidden
        $('#error_list').empty();
        $('#error_alert_box').attr("hidden");

        let cowAddress = $('#inputGroupSelect01').val();
        if (cowAddress === "" || cowAddress === "Choose...") {
            addItemToList(document.getElementById("error_list"), "Cow Address cannot be empty");
        }

        let partId = $('#inputPartValuePartId').val();
        if (partId === "") {
            addItemToList(document.getElementById("error_list"), "Part ID cannot be empty");
        }

        let newValue = $('#inputPurchaseNewPartValue').val();
        if (newValue === "") {
            addItemToList(document.getElementById("error_list"), "New value cannot be empty");
        }

        if (document.querySelectorAll("#error_list > li").length > 0) {
            console.log("Errors while adding cow.");
            $('#error_alert_box').removeAttr("hidden");
        } else {

            web3Contract.setPartValue.sendTransaction(cowAddress, partId, newValue, {
                from: _activeAccount,
                gas: 1000000,
                gasPrice: 100
            }, (error, result) => {
                if (error !== null) {
                    alert(error);
                } else {
                    console.log("Wagyu part price change ( " + result + ")");
                }
            });
        }
    }
</script>
</body>
</html>